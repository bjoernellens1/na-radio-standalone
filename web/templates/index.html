<!doctype html>
<html lang="en" data-bs-theme="dark">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>na-radio demo</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .video-container {
      position: relative;
      width: 100%;
      padding-bottom: 75%;
      /* 4:3 Aspect Ratio */
      background-color: #000;
      border-radius: 8px;
      overflow: hidden;
    }

    .video-container img {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .pred-item {
      transition: all 0.2s;
    }
  </style>
</head>

<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
    <div class="container">
      <a class="navbar-brand" href="#">NA-RADIO Demo</a>
      <span class="navbar-text ms-auto" id="encoder-name"></span>
    </div>
  </nav>

  <div class="container">
    <div class="row">
      <!-- Left Column: Video Feed -->
      <div class="col-lg-8 mb-4">
        <div class="card shadow-sm">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Live Feed</h5>
            <span id="status-badge" class="badge bg-secondary">Connecting...</span>
          </div>
          <div class="card-body p-0">
            <div class="video-container">
              <img src="/video_feed" alt="Video Feed">
            </div>
          </div>
          <div class="card-footer text-muted d-flex justify-content-between">
            <span id="fps-display">FPS: --</span>
            <span id="inference-display">Inference: -- ms</span>
          </div>
        </div>
      </div>

      <!-- Right Column: Controls & Predictions -->
      <div class="col-lg-4">

        <!-- Predictions Card -->
        <div class="card shadow-sm mb-4">
          <div class="card-header">
            <h5 class="mb-0">Top Predictions</h5>
          </div>
          <ul class="list-group list-group-flush" id="pred-list">
            <li class="list-group-item text-muted">Waiting for data...</li>
          </ul>
        </div>

        <!-- Controls Card -->
        <div class="card shadow-sm mb-4">
          <div class="card-header">
            <h5 class="mb-0">Controls</h5>
          </div>
          <div class="card-body">

            <!-- Object Marking -->
            <div class="mb-4">
              <div class="mb-3">
                <label class="form-label">Vocabulary Mode</label>
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="vocabMode" id="modeCustom" value="custom" checked
                    onchange="handleModeChange()">
                  <label class="form-check-label" for="modeCustom">Custom</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="vocabMode" id="modeImageNet" value="imagenet"
                    onchange="handleModeChange()">
                  <label class="form-check-label" for="modeImageNet">ImageNet (1000 classes)</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="vocabMode" id="modeCOCO" value="coco"
                    onchange="handleModeChange()">
                  <label class="form-check-label" for="modeCOCO">COCO (80 classes)</label>
                </div>
              </div>

              <div class="mb-3">
                <label for="resolutionSelect" class="form-label">Processing Resolution</label>
                <select class="form-select" id="resolutionSelect" onchange="updateResolution()">
                  <option value="1920x1080">1920x1080 (High)</option>
                  <option value="1280x720">1280x720</option>
                  <option value="800x600">800x600</option>
                  <option value="640x480">640x480</option>
                  <option value="512x512" selected>512x512 (Default)</option>
                  <option value="320x240">320x240 (Fast)</option>
                </select>
              </div>

              <div class="mb-3">
                <button class="btn btn-warning w-100" onclick="resetInference()">
                  <i class="bi bi-arrow-counterclockwise"></i> Reset Inference
                </button>
              </div>

              <div class="mb-3">
                <label for="labelInput" class="form-label">Custom Labels (comma-separated)</label>
                <input type="text" class="form-control" id="labelInput" placeholder="person, car, dog..."
                  value="person, car, dog, cat, tree">
              </div>
              <button class="btn btn-primary w-100 mb-3" onclick="updateLabels()">Update Vocabulary</button>

              <hr>

              <div class="d-grid gap-2">
                <button id="heatmapBtn" class="btn btn-outline-danger" onclick="toggleHeatmap()">Enable Heatmap</button>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      function toggleCustomInput() {
        const isCustom = document.getElementById('modeCustom').checked;
        document.getElementById('labelInput').disabled = !isCustom;
      }

      async function updatePredictions() {
        try {
          const resp = await fetch('/predictions');
          const data = await resp.json();
          const ul = document.getElementById('pred-list');
          ul.innerHTML = '';

          if (data.length === 0) {
            ul.innerHTML = '<li class="list-group-item text-muted">No predictions</li>';
            return;
          }

          for (const [label, score] of data) {
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-center pred-item';

            // Colorize high confidence
            let badgeClass = 'bg-secondary';
            if (score > 0.3) badgeClass = 'bg-primary';
            if (score > 0.5) badgeClass = 'bg-success';

            li.innerHTML = `
              ${label}
              <span class="badge ${badgeClass} rounded-pill">${score.toFixed(3)}</span>
            `;
            ul.appendChild(li);
          }
        } catch (e) {
          console.warn('Pred fetch failed', e);
        }
      }

      async function updateStatus() {
        try {
          const resp = await fetch('/status');
          const data = await resp.json();

          // Camera Status
          const stBadge = document.getElementById('status-badge');
          if (data.camera_open) {
            stBadge.textContent = 'Connected';
            stBadge.className = 'badge bg-success';
          } else {
            stBadge.textContent = 'No Camera';
            stBadge.className = 'badge bg-danger';
          }

          // Encoder Name
          if (data.encoder) {
            document.getElementById('encoder-name').textContent = `Encoder: ${data.encoder}`;
          }

          // Stats
          if (data.fps !== undefined) {
            document.getElementById('fps-display').textContent = `FPS: ${data.fps}`;
            document.getElementById('inference-display').textContent = `Inference: ${data.inference_time_ms} ms`;
          }

          // Heatmap Button
          const hmBtn = document.getElementById('heatmapBtn');
          if (data.heatmap_enabled) {
            hmBtn.textContent = 'Disable Heatmap';
            hmBtn.className = 'btn btn-danger w-100';
          } else {
            hmBtn.textContent = 'Enable Heatmap';
            hmBtn.className = 'btn btn-outline-danger w-100';
          }

        } catch (e) {
          console.warn('Status fetch failed', e);
        }
      }

      async function updateLabels() {
        const mode = document.querySelector('input[name="vocabMode"]:checked').value;
        const labels = document.getElementById('labelInput').value;

        try {
          const resp = await fetch('/update_labels', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              mode: mode,
              labels: labels
            })
          });
          const data = await resp.json();
          if (data.success) {
            const btn = document.querySelector('button[onclick="updateLabels()"]');
            const originalText = btn.textContent;
            btn.textContent = 'Saved!';
            btn.className = 'btn btn-success w-100 mb-3';
            setTimeout(() => {
              btn.textContent = originalText;
              btn.className = 'btn btn-primary w-100 mb-3';
            }, 2000);
          } else {
            alert('Error: ' + data.error);
          }
        } catch (e) {
          console.error('Update labels failed', e);
          alert('Failed to update labels');
        }
      }

      function toggleHeatmap() {
        fetch('/toggle_heatmap', { method: 'POST' })
          .then(response => response.json())
          .then(data => {
            // heatmapEnabled = data.heatmap_enabled; // This variable is not defined in the original code.
            updateStatus(); // Rely on updateStatus to refresh UI based on server state
          })
          .catch(e => {
            console.error('Toggle heatmap failed', e);
          });
      }

      function resetInference() {
        fetch('/reset_inference', { method: 'POST' })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              alert('Inference reset successfully. Re-encoding labels...');
            } else {
              alert('Failed to reset inference.');
            }
          })
          .catch(err => {
            console.error(err);
            alert('Error resetting inference.');
          });
      }

      function updateResolution() {
        const select = document.getElementById('resolutionSelect');
        const [w, h] = select.value.split('x').map(Number);

        fetch('/update_resolution', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ width: w, height: h })
        })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              console.log('Resolution updated to', w, h);
            } else {
              alert('Failed to update resolution');
            }
          })
          .catch(err => console.error('Error updating resolution:', err));
      }
      setInterval(updateStatus, 1000);
      updateStatus();
      setInterval(updatePredictions, 1000);
      updatePredictions();
    </script>
</body>

</html>